var ImageSliderGame=function(a,b,c){var d=this;d.imgSrc=a,d.nbOfTilesV=b,d.nbOfTilesH=c,d.tiles=[],d.canvas=document.querySelector("canvas"),d.ctx=d.canvas.getContext("2d"),d.img=new Image,d.tilesSize=null,d.moveController=new MoveController(d.nbOfTilesV,d.nbOfTilesH),d.menu=new Menu,d.maxWidth=parseInt(window.getComputedStyle(document.querySelector("body")).maxWidth),d.bgImg=new Image,d.bgImgSrc="im/bg.jpg",d.video=document.querySelector("video"),d.localMediaStream=null,d.drawCameraImageInterval=null,d.showingCamera=!1,d.cameraCanvas=null,d.setUp=function(){d.resizeCanvas(),d.loadGameImages(),d.setUpNavigator()},d.setUpNavigator=function(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia},d.resize=function(){d.resizeCanvas(),d.updateTiles()},d.resizeCanvas=function(){window.innerWidth<d.maxWidth?d.canvas.width=window.innerWidth:d.canvas.width=d.maxWidth,d.canvas.height=window.innerHeight-d.menu.height,d.cameraCanvas&&(d.cameraCanvas.width=d.canvas.width,d.cameraCanvas.height=d.canvas.height)},d.loadGameImages=function(){d.img.src=d.imgSrc,d.img.onload=function(){d.imgLoaded(d.img)},d.bgImg.src=d.bgImgSrc,d.bgImg.onload=function(){document.querySelector("body").style.backgroundImage="url("+d.bgImgSrc+")",d.imgLoaded(d.bgImg)}},d.imgLoaded=function(a){a.loaded=!0,d.startGame()},d.startGame=function(){d.img.loaded&&d.bgImg.loaded&&(d.setUpTiles(),d.updateTiles(),d.canvas.addEventListener("mousedown",d.onCanvasMouseDown),d.canvas.addEventListener("touchstart",d.onCanvasMouseDown),d.setUpMenu())},d.setUpMenu=function(){d.menu.setUp(),d.menu.decNbOfTilesVButton.addEventListener("click",d.decNbOfTilesV),d.menu.setNbOfTilesVText(d.nbOfTilesV),d.menu.incNbOfTilesVButton.addEventListener("click",d.incNbOfTilesV),d.menu.decNbOfTilesHButton.addEventListener("click",d.decNbOfTilesH),d.menu.setNbOfTilesHText(d.nbOfTilesH),d.menu.incNbOfTilesHButton.addEventListener("click",d.incNbOfTilesH),d.menu.restartButton.addEventListener("click",d.restart),d.menu.loadImageButton.addEventListener("click",d.loadImageFile),d.menu.photoButton.addEventListener("click",d.showCamera),d.menu.solveButton.addEventListener("click",d.solve)},d.decNbOfTilesV=function(){d.nbOfTilesV-1>2&&(d.nbOfTilesV--,d.menu.setNbOfTilesVText(d.nbOfTilesV),d.restart())},d.incNbOfTilesV=function(){d.nbOfTilesV++,d.menu.setNbOfTilesVText(d.nbOfTilesV),d.restart()},d.decNbOfTilesH=function(){d.nbOfTilesH-1>2&&(d.nbOfTilesH--,d.menu.setNbOfTilesHText(d.nbOfTilesH),d.restart())},d.incNbOfTilesH=function(){d.nbOfTilesH++,d.menu.setNbOfTilesHText(d.nbOfTilesH),d.restart()},d.showCamera=function(){d.menu.photoButton.removeEventListener("click",d.showCamera),d.menu.showText("Loading camera..."),navigator.getUserMedia({video:!0},function(a){d.video.src=window.URL.createObjectURL(a),d.localMediaStream=a,d.video.addEventListener("playing",d.drawCameraImage)},function(){d.menu.showText("Error while loading camera"),d.menu.photoButton.addEventListener("click",d.showCamera)})},d.drawCameraImage=function(){d.video.removeEventListener("playing",d.drawCameraImage),d.menu.showText("Click on video to take a picture!"),d.cameraCanvas=document.createElement("canvas"),d.cameraCanvas.setAttribute("id","cameraCanvas"),d.canvas.removeEventListener("mousedown",d.onCanvasMouseDown),d.canvas.removeEventListener("touchstart",d.onCanvasMouseDown),document.querySelector("body").appendChild(d.cameraCanvas);var a=d.cameraCanvas.getContext("2d");d.cameraCanvas.width=d.canvas.width,d.cameraCanvas.height=d.canvas.height,d.showingCamera=!0,d.ctx.fillStyle=d.ctx.createPattern(d.bgImg,"repeat"),d.ctx.fillRect(0,0,d.canvas.width,d.canvas.height);for(var b=0;b<d.tiles.length;b++)d.tiles[b].clear();d.drawCameraImageInterval=setInterval(function(){try{a.drawImage(d.video,0,0,d.cameraCanvas.width,d.cameraCanvas.height)}catch(b){return}d.canvas.addEventListener("click",d.takePicture)},100)},d.takePicture=function(){clearInterval(d.drawCameraImageInterval),d.menu.hideText(),d.canvas.removeEventListener("click",d.takePicture),d.canvas.addEventListener("mousedown",d.onCanvasMouseDown),d.canvas.addEventListener("touchstart",d.onCanvasMouseDown),d.menu.photoButton.addEventListener("click",d.showCamera),d.img=new Image,d.img.onload=d.restart,d.img.src=d.cameraCanvas.toDataURL(),d.video.pause(),d.localMediaStream.stop(),d.localMediaStream=null,document.querySelector("body").removeChild(d.cameraCanvas),d.cameraCanvas=null,d.showingCamera=!1},d.restart=function(){d.menu.hideText(),d.tiles=[],d.ctx.clearRect(0,0,d.canvas.width,d.canvas.height),d.moveController=new MoveController(d.nbOfTilesV,d.nbOfTilesH),d.setUpTiles(),d.updateTiles()},d.loadImageFile=function(){d.menu.fileInput.addEventListener("change",d.onImageSelect),d.menu.fileInput.click()},d.onImageSelect=function(){d.menu.fileInput.removeEventListener("change",d.onImageChange);var a=new FileReader;a.onload=function(){d.img=new Image,d.img.onload=d.restart,d.img.src=a.result},a.readAsDataURL(d.menu.fileInput.files[0])},d.setUpTiles=function(){for(var a=d.nbOfTilesV*d.nbOfTilesH,b=(new Shuffler).mix(d.nbOfTilesV,d.nbOfTilesH),c=0;a>c;c++){var e=new Tile(d.ctx,d.img,b[c]);b[c]==a-1&&e.setHidden(!0),d.tiles.push(e)}},d.updateTiles=function(){d.showingCamera&&(d.ctx.fillStyle=d.ctx.createPattern(d.bgImg,"repeat"),d.ctx.fillRect(0,0,d.canvas.width,d.canvas.height));for(var a=!0,b=0;b<d.tiles.length;b++){var c=d.tiles[b].clipIndex;c!=b&&(a=!1);var e=new Size(Math.floor(d.canvas.width/d.nbOfTilesV),Math.floor(d.canvas.height/d.nbOfTilesH)),f=new Position(b%d.nbOfTilesV*e.width,Math.floor(b/d.nbOfTilesV)*e.height),g=new Size(Math.floor(d.img.width/d.nbOfTilesV),Math.floor(d.img.height/d.nbOfTilesH)),h=new Position(c%d.nbOfTilesV*g.width,Math.floor(c/d.nbOfTilesV)*g.height);d.tilesSize=e,d.tiles[b].setPos(f),d.tiles[b].setSize(e),d.tiles[b].setClip(new Clip(h,g)),d.showingCamera?d.tiles[b].clear():d.tiles[b].draw()}if(a){d.menu.showText("Well done!");for(var b=0;b<d.tiles.length;b++)d.tiles[b].hidden&&(d.tiles[b].hidden=!1),d.tiles[b].padding=0,d.tiles[b].draw()}},d.onCanvasMouseDown=function(a){var b=d.getMousePos(a);if(null!=b){var c=d.getTileIndex(b),e=new Position(d.tiles[c].pos.x,d.tiles[c].pos.y),f=d.moveController.possibleMove(d.tiles,c);null!=f&&(d.onCanvasMouseMove=function(a){var g=d.getMousePos(a);null!=g&&(d.tiles[c].move(e,g,b,f),d.tiles[c].draw())},d.onCanvasMouseUp=function(a){document.querySelector("html").removeEventListener("mouseup",d.onCanvasMouseUp),document.querySelector("html").removeEventListener("mouseout",d.onCanvasMouseUp),document.querySelector("html").removeEventListener("touchend",d.onCanvasMouseUp),d.canvas.removeEventListener("mousemove",d.onCanvasMouseMove),d.canvas.removeEventListener("touchmove",d.onCanvasMouseMove),d.moveController.moveIfPossible(d.tiles,c,d.endAnimation)},d.canvas.addEventListener("mousemove",d.onCanvasMouseMove),d.canvas.addEventListener("touchmove",d.onCanvasMouseMove),document.querySelector("html").addEventListener("mouseup",d.onCanvasMouseUp),document.querySelector("html").addEventListener("mouseout",d.onCanvasMouseUp),document.querySelector("html").addEventListener("touchend",d.onCanvasMouseUp),d.canvas.removeEventListener("mousedown",d.onCanvasMouseDown),d.canvas.removeEventListener("touchstart",d.onCanvasMouseDown))}},d.endAnimation=function(){d.updateTiles(),d.canvas.addEventListener("mousedown",d.onCanvasMouseDown),d.canvas.addEventListener("touchstart",d.onCanvasMouseDown)},d.getTileIndex=function(a){var b=Math.floor(a.x/d.tilesSize.width),c=Math.floor(a.y/d.tilesSize.height);return b+c*d.nbOfTilesV},d.getMousePos=function(a){return"mousedown"==a.type||"mousemove"==a.type?new Position(a.clientX-d.canvas.offsetLeft,a.clientY-d.canvas.offsetTop):"touchstart"==a.type||"touchmove"==a.type?(a.preventDefault(),1==a.targetTouches.length?new Position(a.targetTouches[0].pageX-d.canvas.offsetLeft,a.targetTouches[0].pageY-d.canvas.offsetTop):null):void 0},d.solve=function(){d.canvas.removeEventListener("mousedown",d.onCanvasMouseDown),d.canvas.removeEventListener("touchstart",d.onCanvasMouseDown),d.menu.decNbOfTilesVButton.removeEventListener("click",d.decNbOfTilesV),d.menu.incNbOfTilesVButton.removeEventListener("click",d.incNbOfTilesV),d.menu.decNbOfTilesHButton.removeEventListener("click",d.decNbOfTilesH),d.menu.incNbOfTilesHButton.removeEventListener("click",d.incNbOfTilesH),d.menu.restartButton.removeEventListener("click",d.restart),d.menu.loadImageButton.removeEventListener("click",d.loadImageFile),d.menu.photoButton.removeEventListener("click",d.showCamera),d.menu.solveButton.removeEventListener("click",d.solve),d.menu.showText("Solving puzzle...");var a=new Solver(d.tiles,d.nbOfTilesV,d.nbOfTilesH).solve();try{d.solveAnimationStep(a,0,d.updateTiles,d.endSolveAnimation)}catch(b){d.endSolveAnimation()}},d.solveAnimationStep=function(a,b,c,e){b<a.length?(d.moveController=new MoveController(d.nbOfTilesV,d.nbOfTilesH),d.moveController.moveIfPossible(d.tiles,a[b],function(){c(),setTimeout(function(){d.solveAnimationStep(a,b+1,c,e)},100)})):e()},d.endSolveAnimation=function(){d.updateTiles(),d.canvas.addEventListener("mousedown",d.onCanvasMouseDown),d.canvas.addEventListener("touchstart",d.onCanvasMouseDown),d.menu.decNbOfTilesVButton.addEventListener("click",d.decNbOfTilesV),d.menu.incNbOfTilesVButton.addEventListener("click",d.incNbOfTilesV),d.menu.decNbOfTilesHButton.addEventListener("click",d.decNbOfTilesH),d.menu.incNbOfTilesHButton.addEventListener("click",d.incNbOfTilesH),d.menu.restartButton.addEventListener("click",d.restart),d.menu.loadImageButton.addEventListener("click",d.loadImageFile),d.menu.photoButton.addEventListener("click",d.showCamera),d.menu.solveButton.addEventListener("click",d.solve)}};